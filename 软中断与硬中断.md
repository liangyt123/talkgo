# 什么是中断
中断是种异步事件处理机制，能提高机器的并发能力。为了减少对正常程序的影响，中断程序的处理时间应该很短，中断程序应该很精简。中断为了保护硬件与系统数据一致，当中断处理的时候，会关闭中断。就像打电话一样，此时其他电话打过来，会表示占线。此时其他电话应该要进行重试，当然，重试一直不成功，就会一直丢失中断。
为了达到更快的中断处理，linux把系统中断处理分为上半部与下半部。上半部快速处理中断，下半部延时处理中断。
## 硬中断（上半部）
网卡接收到数据后，会通过硬件中断的形式，通知内核有新的数据到了，内核会调用中断程序来响应这个硬件中断，实际是把网卡信息读到内存中，然后更新下硬件寄存器，表示数据已经读好了，再发出一个软中断信号，通知下一步操作
## 软中断（下半部）
下半部被软中断信号唤醒后，从内存中找到网络数据，再

# 分析软中断造成的性能问题
用top命令发现CPU使用率不高，但系统变慢，如果发现ksoftirqd线程消耗CPU占比比较多，那就可能是软中断过多的问题了。
watch -d cat /proc/softirqs 可以看到是各种类型的软中断次数的变化率，通过工具sar 并添加-n DEV参数显示网络收发情况。一开始用sar 会报Cannot open /var/log/sysstat/sa03: No such file or directory 错误，此时用sar -o 2 3 创建该文件即可。

```shell
root@iZm5e78t3hp8rw0t2g09ikZ:~# sar -n DEV
Linux 4.4.0-151-generic (iZm5e78t3hp8rw0t2g09ikZ) 	06/03/2020 	_x86_64_	(1 CPU)

06:29:40 AM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
06:29:42 AM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
06:29:42 AM   docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
06:29:42 AM      eth0      3.54      1.52      0.21      0.44      0.00      0.00      0.00      0.00
```

第一列:报告的时间

第二列：IFACE表示网卡

第三，第四列：rxpck/s和txpck/s表示每秒接收，发送的网络帧数，PPS

第五，第六列：rxkB/s和txkB/s表示每秒接收，发送的千字节数,BPS

如果接收的PPS比较大12607，而接收的BPS比较小664KB，其中664*1024/12607 = 54byte 说明网络帧只有54byte，这就是小包问题了。

通过tcpdump进行抓包tcpdump -i eth0 -n tcp port 80

如果有太多Flags[s],表示有过多SYN包，表示受到SYN FLOOD攻击

## 小结

软中断升高很影响系统性能的，所以网络收发包要对小包进行处理